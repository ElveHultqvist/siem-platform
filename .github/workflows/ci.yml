name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  lint-go:
    name: Lint Go Services
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'
      
      - name: golangci-lint
        uses: golangci/golangci-lint-action@v3
        with:
          version: latest
          args: --timeout=5m
          working-directory: services/ingest-service
      
      - name: Run go fmt
        run: |
          for dir in services/*/; do
            if [ -f "$dir/go.mod" ]; then
              echo "Checking $dir..."
              cd $dir
              test -z "$(gofmt -l .)"
              cd -
            fi
          done

  lint-python:
    name: Lint Python Services
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install flake8 black mypy isort
      
      - name: Run black
        run: |
          for dir in services/*/; do
            if [ -f "$dir/requirements.txt" ]; then
              echo "Checking $dir..."
              black --check $dir || exit 1
            fi
          done
      
      - name: Run flake8
        run: |
          for dir in services/*/; do
            if [ -f "$dir/requirements.txt" ]; then
              echo "Linting $dir..."
              flake8 $dir --max-line-length=100 --extend-ignore=E203,W503 || exit 1
            fi
          done

  test-go:
    name: Test Go Services
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'
      
      - name: Run tests
        run: |
          for dir in services/*/; do
            if [ -f "$dir/go.mod" ]; then
              echo "Testing $dir..."
              cd $dir
              go test -v -race -coverprofile=coverage.out ./...
              cd -
            fi
          done

  test-python:
    name: Test Python Services
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Run tests
        run: |
          for dir in services/*/; do
            if [ -f "$dir/requirements.txt" ]; then
              echo "Testing $dir..."
              cd $dir
              pip install -r requirements.txt
              pip install pytest pytest-cov
              python -m pytest tests/ -v --cov=. --cov-report=term-missing || exit 1
              cd -
            fi
          done

  helm-lint:
    name: Lint Helm Charts
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Helm
        uses: azure/setup-helm@v3
        with:
          version: '3.13.0'
      
      - name: Lint Helm Charts
        run: |
          for chart in deploy/helm/*/; do
            echo "Linting $chart..."
            helm lint $chart
          done

  build-images:
    name: Build Docker Images
    runs-on: ubuntu-latest
    needs: [lint-go, lint-python, test-go, test-python]
    if: github.event_name == 'push'
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Build images
        run: |
          for dir in services/*/; do
            service=$(basename $dir)
            if [ -f "$dir/Dockerfile" ]; then
              echo "Building $service..."
              docker build -t siem-platform/$service:${{ github.sha }} $dir
            fi
          done
